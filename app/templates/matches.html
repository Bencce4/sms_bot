{% extends "base.html" %}
{% block content %}
<h2>Preview & Filter</h2>

<form method="post" action="/admin/preview" style="margin-bottom:12px;">
  <label>City</label>
  <select name="city">
    <option value="">All</option>
    {% for c in cities %}
      <option value="{{ c }}" {% if city_sel==c %}selected{% endif %}>{{ c }}</option>
    {% endfor %}
  </select>

  <label>Profession</label>
  <select name="prof">
    <option value="">All</option>
    {% for p in profs %}
      <option value="{{ p }}" {% if prof_sel==p %}selected{% endif %}>{{ p }}</option>
    {% endfor %}
  </select>

  <label>Limit</label>
  <input type="number" name="limit" min="1" max="1000" value="{{ limit }}" />
  <button type="submit">Preview</button>
</form>

<p>Total in filter: {{ total }}</p>

<table>
  <thead>
    <tr>
      <th style="width:28px;">
        <input type="checkbox" id="chkAll" title="Select all">
      </th>
      <th>match_id</th>
      <th>Miestas</th>
      <th>Specialybė</th>
      <th>Tel. nr</th>
      <th>Chat</th>
    </tr>
  </thead>
  <tbody>
    {% if rows and rows|length > 0 %}
      {% for m in rows %}
        {% set phone = (m["Tel. nr"] or "") %}
        <tr>
          <td>
            {% if phone %}
              <!-- bind checkbox to the send form -->
              <input type="checkbox" name="selected" form="sendForm" value="{{ phone|trim }}">
            {% endif %}
          </td>
          <td>{{ m.match_id }}</td>
          <td>{{ m.Miestas }}</td>
          <td>{{ m.Specialybė }}</td>
          <td>{{ phone }}</td>
          <td>
            {% if phone %}
              <a class="btn" href="/admin/chat?phone={{ phone | urlencode }}" target="_blank">Chat</a>
            {% else %}—{% endif %}
          </td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="6" style="text-align:center; color:#666;">
          No matches found for the current data. Check city/profession or project “Aktualūs”.
        </td>
      </tr>
    {% endif %}
  </tbody>
</table>

<!-- Send: now receives selected[]=... + current filters -->
<form method="post" action="/admin/send" id="sendForm" style="margin-top:10px;">
  <input type="hidden" name="city"  value="{{ city_sel or '' }}">
  <input type="hidden" name="prof"  value="{{ prof_sel or '' }}">
  <input type="hidden" name="limit" value="{{ limit }}">
  <button type="submit" class="btn" {% if not rows or rows|length == 0 %}disabled{% endif %}>Send</button>
</form>

<script>
  const chkAll = document.getElementById('chkAll');
  if (chkAll) {
    chkAll.addEventListener('change', () => {
      document.querySelectorAll('input[type=checkbox][name=selected]')
        .forEach(cb => cb.checked = chkAll.checked);
    });
  }
</script>
{% endblock %}
